name: Setup Job
description: Common setup steps for workflows
inputs:
  build-artifact-name:
    required: false
    description: Name of the build artifact
    default: ''
  wheel-artifact-name:
    required: false
    description: Name of the wheel artifact
    default: ''
  path:
    required: false
    description: Where to checkout
    default: docker-job
  enable-watcher:
    description: 'Enable watcher'
    default: false
    type: boolean
runs:
  using: "composite"
  steps:
    - name: ðŸ§¬ Checkout Repository
      uses: actions/checkout@v4
      with:
        submodules: recursive
        path: ${{ inputs.path }}

    # - name: ðŸ§ª Check Required Tools
    #   run: |
    #     echo "ðŸ” Verifying tools..."
    #     command -v tar >/dev/null 2>&1 && tar --version || { echo "âŒ tar not found"; exit 1; }
    #     command -v pip3 >/dev/null 2>&1 && pip3 --version || { echo "âŒ pip3 not found"; exit 1; }
    #   shell: bash

    - name: ðŸ“¦ Download Build Artifact
      if: ${{ inputs.build-artifact-name != '' }}
      uses: actions/download-artifact@v4
      with:
        name: ${{ inputs.build-artifact-name }}
        path: ${{ inputs.path }}

    - name: ðŸ“‚ Extract Build Files
      if: ${{ inputs.build-artifact-name != '' }}
      working-directory: ${{ inputs.path }}
      run: tar -xf ttm_any.tar
      shell: bash

    - name: ðŸ§ª Download Python Wheel
      if: ${{ inputs.wheel-artifact-name != '' }}
      uses: actions/download-artifact@v4
      with:
        name: ${{ inputs.wheel-artifact-name }}
        path: ${{ inputs.path }}

    - name: "Install Cached Python Dependencies"
      uses: getsentry/action-setup-venv@v2.1.1
      id: venv
      with:
        python-version: ${{ inputs.python-version }}
        venv-dir: ${{ github.workspace }}/python_env
        cache-dependency-path: |
          tt_metal/python_env/requirements-dev.txt
          docs/requirements-docs.txt
          tests/sweep_framework/requirements-sweeps.txt
          pyproject.toml
          create_venv.sh
        install-cmd: ./create_venv.sh

    - name: ðŸ’¿ Install Wheel
      if: ${{ inputs.wheel-artifact-name != '' }}
      working-directory: ${{ inputs.path }}
      run: |
        echo "ðŸ“‚ In directory: $(pwd)"
        echo "ðŸ“„ Files:"
        ls -la
        WHEEL_FILENAME=$(ls -1 *.whl)
        echo "ðŸ“¦ Installing $WHEEL_FILENAME"
        source ${{ github.workspace }}/python_env/bin/activate
        pip3 install "$WHEEL_FILENAME"
      shell: bash

    - name: Set up env vars for watcher
      if: ${{ inputs.enable-watcher == 'true' }}
      working-directory: ${{ inputs.path }}
      run: |
        echo "Enabling TT Metal Watcher"
        echo "TT_METAL_WATCHER=1" >> $GITHUB_ENV
        echo "TT_METAL_WATCHER_APPEND=1" >> $GITHUB_ENV
        echo "TT_METAL_WATCHER_NOINLINE=1" >> $GITHUB_ENV
      shell: bash
