include "tracehost/command.fbs";

namespace tt.target.lightmetal;

// Represents the Descriptor struct inside TraceDescriptor
table Descriptor {
    num_completion_worker_cores: uint32;
    num_traced_programs_needing_go_signal_multicast: uint32;
    num_traced_programs_needing_go_signal_unicast: uint32;
}

// Represents a key-value pair for SubDeviceId -> Descriptor mapping
table SubDeviceDescriptorMapping {
    sub_device_id: uint8;
    descriptor: Descriptor;
}

// Matches C++ struct detail::TraceDescriptor
table TraceDescriptor {
    trace_data: [uint32];
    sub_device_descriptors: [SubDeviceDescriptorMapping]; // Vector of key-value pairs
    sub_device_ids: [uint8]; // Optimized vector of sub_device_ids
}

// Associate key (trace_id) to value (TraceDescriptor)
table TraceDescriptorByTraceId {
    trace_id: uint32 (key);
    desc: TraceDescriptor;
}

// Top level Binary, eventually containing everything to run.
table LightMetalBinary {
    // TODO - Git Hash, Versioning, etc.
    // TODO - Commands
    // TODO - Programs
    commands: [tt.target.Command];
    trace_descriptors: [TraceDescriptorByTraceId];  // Metal "Traces"
}

root_type LightMetalBinary;
